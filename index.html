<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>US County Housing — Cartopy Globe (Light)</title>
<style>
  :root{
    --ring:#4a5568; --text:#1a1a1a; --muted:#666; --bg:#f5f5f7;
    --glass:rgba(255,255,255,0.25); --glass-border:rgba(255,255,255,0.4);
  }
  html,body{height:100%; margin:0; background:var(--bg);}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Arial; color:var(--text); overflow:hidden;}

  .control-panel{
    position:fixed; left:20px; top:20px; z-index:10;
    background:var(--glass); border:1px solid var(--glass-border); backdrop-filter:blur(30px) saturate(200%);
    box-shadow:0 8px 32px rgba(0,0,0,.1), 0 1px 0 rgba(255,255,255,.6) inset;
    border-radius:16px; padding:20px; width:280px; max-height:80vh; overflow:auto;
  }
  .section{ margin-bottom:20px; }
  .legend-title{ font-weight:700; margin-bottom:8px; }
  .bar{height:12px; border-radius:8px; margin:8px 0;}
  .minmax{display:flex; justify-content:space-between; color:var(--muted); font-size:12px;}
  label{font-size:13px; color:var(--muted); display:block; margin:0 0 6px;}
  select,button{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.4);
    background:rgba(255,255,255,.3); color:var(--text); font-size:13px; margin-bottom:12px; backdrop-filter:blur(15px);
  }
  select[multiple]{min-height:90px;}
  #globe{ position:fixed; inset:0; background:transparent; }
  .err{position:fixed; right:20px; bottom:20px; background:#7f1d1d; color:#fee2e2; padding:10px 12px; border-radius:10px; border:1px solid #ef4444}
</style>
</head>
<body>
  <div class="control-panel">
    <div class="section">
      <div id="legend-title" class="legend-title"></div>
      <div class="bar" id="legend-bar"></div>
      <div class="minmax"><span id="legend-min">-</span><span id="legend-max">-</span></div>
    </div>
    <div class="section">
      <label for="metric">Metric</label>
      <select id="metric"></select>
      <label for="states">State</label>
      <select id="states" multiple></select>
      <button id="resetSel">Reset Selection</button>
      <div id="period" style="color:#888; font-size:12px;"></div>
    </div>
    <div class="section">
      <div id="pinned" style="display:none"></div>
    </div>
  </div>

  <div id="globe"></div>

  <!-- Libs -->
  <script src="https://unpkg.com/three@0.164.1/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl@2.34.5/dist/globe.gl.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <script>
  (async function() {
    function err(msg) {
      console.error(msg);
      const el=document.createElement('div'); el.className='err'; el.textContent=msg;
      document.body.appendChild(el); setTimeout(()=>el.remove(),8000);
    }

    // 1) 运行时加载同目录 JSON
    let rows, PERIOD='Latest', COUNTIES_TOPO, WORLD_LAND;
    try {
      const [v,p,c,w] = await Promise.all([
        fetch('./county_values_latest.json').then(r=>r.json()),
        fetch('./period.txt').then(r=>r.ok?r.text():'Latest').catch(_=>'Latest'),
        fetch('./counties-10m.json').then(r=>r.json()),
        fetch('./world_land_natural.json').then(r=>r.json())
      ]);
      rows = v; PERIOD = (p||'Latest').trim();
      COUNTIES_TOPO = c; WORLD_LAND = w;
    } catch(e) {
      err('Failed to load JSON files. Make sure all 3 JSONs exist next to index.html');
      return;
    }

    // 2) 填充下拉
    const metricSel = document.getElementById('metric');
    const statesSel = document.getElementById('states');
    const periodEl  = document.getElementById('period');
    const legendTitle = document.getElementById('legend-title');
    const legendMin   = document.getElementById('legend-min');
    const legendMax   = document.getElementById('legend-max');
    const legendBar   = document.getElementById('legend-bar');
    const pinnedEl    = document.getElementById('pinned');

    const metrics = rows.length ? Object.keys(rows[0]).filter(k=>!['FIPS','REGION','STATE_CODE'].includes(k)) : [];
    metricSel.innerHTML = metrics.map(m=>`<option value="${m}">${m.replaceAll('_',' ').toUpperCase()}</option>`).join('');
    if (metrics.includes('MEDIAN_DOM')) metricSel.value = 'MEDIAN_DOM';
    const states = Array.from(new Set(rows.map(r=>r.STATE_CODE))).sort();
    statesSel.innerHTML = `<option value="(All)">(All)</option>` + states.map(s=>`<option value="${s}">${s}</option>`).join('');
    if (statesSel.options.length) statesSel.options[0].selected = true;
    periodEl.textContent = `Period: ${PERIOD}`;

    // 3) 主题
    const THEME = {
      PALETTE: ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'],
      ACCENT:  'rgba(0,122,255,0.8)',
      HOVER:   'rgba(255,255,255,0.85)',
      STROKE_SELECTED: 'rgba(0,122,255,0.9)',
      STROKE_HOVER:    'rgba(0,122,255,0.7)',
      ALT_HOVER_MULT:  1.6,
      ALT_SELECT_MULT: 2.2,
      LABEL_BG:    'rgba(255,255,255,0.25)',
      LABEL_BORDER:'1px solid rgba(255,255,255,0.4)',
      LABEL_TEXT:  '#1a1a1a'
    };

    // 4) 球
    const globe = Globe()(document.getElementById('globe'))
      .backgroundColor('rgba(0,0,0,0)')
      .width(window.innerWidth).height(window.innerHeight)
      .pointOfView({ lat: 38, lng: -98, altitude: 1.5 });

    setTimeout(()=>{
      globe.globeImageUrl(null).bumpImageUrl(null).showAtmosphere(false)
           .showGraticules(true)
           .graticulesColor('rgba(0,0,0,0.08)');
      const mat = globe.globeMaterial();
      mat.transparent = true;
      mat.opacity = 0;
      mat.depthWrite = false;
      globe.polygonsTransitionDuration(400);
    }, 300);
    window.addEventListener('resize', ()=>globe.width(window.innerWidth).height(window.innerHeight));

    // 5) topo 转 geojson
    const countiesGeo = topojson.feature(COUNTIES_TOPO, COUNTIES_TOPO.objects.counties);
    const worldLand   = WORLD_LAND;

    // 6) 渲染
    const selectedFips = new Set(); let hoverId=null;
    function pad5(s){return String(s).padStart(5,'0');}
    function quantile(sorted,p){return sorted.length? sorted[Math.floor((sorted.length-1)*p)] : NaN;}
    function fmtVal(metric, v){
      const n=Number(v);
      if(!Number.isFinite(n)) return 'No data';
      if(metric.includes('PRICE')||metric.includes('PPSF')) return `$${n.toLocaleString()}`;
      if(metric==='MEDIAN_DOM') return `${Math.round(n)} days`;
      if(['AVG_SALE_TO_LIST','SOLD_ABOVE_LIST','PRICE_DROPS','OFF_MARKET_IN_TWO_WEEKS'].includes(metric)) return `${(n*100).toFixed(1)}%`;
      return n.toLocaleString();
    }

    function update() {
      const metric = metricSel.value;
      const chosen = Array.from(statesSel.selectedOptions).map(o=>o.value);
      const all = chosen.includes('(All)');

      const byFips = Object.create(null);
      rows.forEach(r=>byFips[pad5(r.FIPS)] = r);

      const vals = rows.filter(r=>all || chosen.includes(r.STATE_CODE))
                       .map(r=>Number(r[metric])).filter(Number.isFinite).sort((a,b)=>a-b);
      if(!vals.length) return;
      const vmin = quantile(vals,0.05), vmax = quantile(vals,0.95);
      const norm = v => (v - vmin)/(vmax - vmin || 1);

      const dataFeats = countiesGeo.features.filter(f=>{
        const rec = byFips[pad5(f.id)];
        return !!rec && (all || chosen.includes(rec.STATE_CODE));
      }).map(f=>{
        const rec = byFips[pad5(f.id)];
        const v = Number(rec?.[metric]);
        const idx = Number.isFinite(v) ? Math.min(7, Math.floor(Math.max(0,Math.min(1,norm(v)))*8)) : 0;
        const hex = THEME.PALETTE[idx].replace('#','');
        const r = parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16);
        f.__baseColor = `rgba(${r}, ${g}, ${b}, 0.7)`;
        f.__altBase = 0.015;
        f.__county = rec?.REGION ?? f.properties?.name ?? 'N/A';
        f.__state  = rec?.STATE_CODE ?? '';
        f.__value  = fmtVal(metric, v);
        f.__label  = `<div style="background:${THEME.LABEL_BG}; border:${THEME.LABEL_BORDER}; padding:12px 16px; border-radius:12px; font:13px/1.4 Inter,system-ui; color:${THEME.LABEL_TEXT};">
          <b>${f.__county}</b><br>${f.__state} — ${f.__value}<br><span style="color:#666; font-size:11px;">${PERIOD} • ${metric.replaceAll('_',' ').toUpperCase()}</span>
        </div>`;
        return f;
      });

      const landFeats = (worldLand?.features || []).map(f=>Object.assign({}, f, {isLand:true}));
      const allPolys = [...landFeats, ...dataFeats];

      globe.polygonsData(allPolys)
        .polygonCapColor(d=> d.isLand ? 'rgba(255,255,255,0.30)'
                           : (selectedFips.has(d.id) ? d.__baseColor
                           : (hoverId===d.id ? THEME.HOVER : d.__baseColor)))
        .polygonSideColor(d=> d.isLand ? 'rgba(255,255,255,0.30)' : (hoverId===d.id?THEME.HOVER:d.__baseColor))
        .polygonStrokeColor(d=> d.isLand ? 'rgba(0,0,0,0)' : 'transparent')
        .polygonAltitude(d=>{
          if(d.isLand) return 0.005;
          const a=d.__altBase||0.015;
          if(selectedFips.has(d.id)) return a*THEME.ALT_SELECT_MULT;
          if(hoverId===d.id) return a; return a;
        })
        .polygonLabel(f => f.isLand ? null : (f.__label || `County ${f.id}`));

      legendTitle.textContent = metric.replaceAll('_',' ').toUpperCase();
      legendBar.style.background = `linear-gradient(90deg, ${THEME.PALETTE.join(',')})`;
      legendMin.textContent = fmtVal(metric, vmin);
      legendMax.textContent = fmtVal(metric, vmax);
    }

    globe.onPolygonHover(f=>{ hoverId = (f && !f.isLand) ? f.id : null; update(); });
    globe.onPolygonClick(f=>{
      if(!f || f.isLand) return;
      if(selectedFips.has(f.id)) selectedFips.delete(f.id); else selectedFips.add(f.id);
      update();
      const data = (globe.polygonsData()||[]).filter(x=>!x.isLand)
        .filter(x=>selectedFips.has(x.id))
        .map(x=>`<div style="border:1px solid rgba(255,255,255,.4);border-radius:12px;padding:10px 12px;margin:6px 0;background:rgba(255,255,255,.2)"><b>${x.__county}</b><br><span style="color:#666">${x.__state} — ${x.__value}</span></div>`).join('');
      const p = document.getElementById('pinned');
      p.innerHTML = data;
      p.style.display = selectedFips.size ? 'block':'none';
    });

    document.getElementById('resetSel').addEventListener('click',()=>{ selectedFips.clear(); update(); document.getElementById('pinned').style.display='none'; });
    metricSel.addEventListener('change', update);
    statesSel.addEventListener('change', update);

    update(); // 首次渲染
  })();
  </script>
</body>
</html>
