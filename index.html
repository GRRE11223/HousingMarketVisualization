<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>US County Housing — No Globe Mesh</title>
<style>
  html,body{height:100%;margin:0;background:transparent;}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Arial;color:#1a1a1a;overflow:hidden;}
  #globe{position:fixed; inset:0; background:transparent;}
  #globe canvas{background:transparent !important;}
  .panel{position:fixed;left:20px;top:20px;z-index:10;width:280px;max-height:80vh;overflow:auto;
         background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.4);backdrop-filter:blur(30px) saturate(200%);
         box-shadow:0 8px 32px rgba(0,0,0,.1),0 1px 0 rgba(255,255,255,.6) inset;border-radius:16px;padding:20px;}
  .section{margin-bottom:20px;}
  label{display:block;font-size:13px;color:#666;margin:0 0 6px;}
  select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.4);
                background:rgba(255,255,255,.3);color:#1a1a1a;font-size:13px;margin-bottom:12px;backdrop-filter:blur(15px);}
  select[multiple]{min-height:90px;}
  .legend-title{font-weight:700;margin-bottom:8px;}
  .bar{height:12px;border-radius:8px;margin:8px 0;}
  .minmax{display:flex;justify-content:space-between;color:#666;font-size:12px;}
  .pin{border:1px solid rgba(255,255,255,.4);border-radius:12px;padding:10px 12px;margin:6px 0;background:rgba(255,255,255,.2)}
</style>
</head>
<body>

<div class="panel">
  <div class="section">
    <div id="legend-title" class="legend-title"></div>
    <div class="bar" id="legend-bar"></div>
    <div class="minmax"><span id="legend-min">-</span><span id="legend-max">-</span></div>
  </div>
  <div class="section">
    <label for="metric">Metric</label>
    <select id="metric"></select>
    <label for="states">State</label>
    <select id="states" multiple></select>
    <button id="resetSel">Reset Selection</button>
    <div id="period" style="color:#888;font-size:12px;"></div>
  </div>
  <div class="section"><div id="pinned" style="display:none"></div></div>
</div>

<div id="globe"></div>

<script src="https://unpkg.com/three@0.164.1/build/three.min.js"></script>
<script src="https://unpkg.com/globe.gl@2.34.5/dist/globe.gl.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script>
(async function(){
  const CONFIG = {
    SHOW_GRATICULES: true,
    GRATICULES_COLOR: 'rgba(0,0,0,0.2)',
    LAND_COLOR: 'rgba(255,255,255,0.30)',
    COUNTY_OPACITY: 0.70,
    ALT_BASE: 0.015,
    ALT_SELECT_MULT: 2.2,
    ALT_HOVER_MULT: 1.0,
    PALETTE: ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'],
    HOVER_COLOR: 'rgba(255,255,255,0.85)'
  };

  // 加载外部 JSON 数据
  const [rows, period, countiesTopo, worldLand] = await Promise.all([
    fetch('./county_values_latest.json').then(r=>r.json()),
    fetch('./period.txt').then(r=>r.text()).catch(()=> 'Latest'),
    fetch('./counties-10m.json').then(r=>r.json()),
    fetch('./world_land_natural.json').then(r=>r.json())
  ]);

  // DOM refs
  const metricSel = document.getElementById('metric');
  const statesSel = document.getElementById('states');
  const periodEl  = document.getElementById('period');
  const legendTitle = document.getElementById('legend-title');
  const legendMin   = document.getElementById('legend-min');
  const legendMax   = document.getElementById('legend-max');
  const legendBar   = document.getElementById('legend-bar');
  const pinnedEl    = document.getElementById('pinned');

  // 初始化下拉
  const metrics = Object.keys(rows[0]).filter(k=>!['FIPS','REGION','STATE_CODE'].includes(k));
  metricSel.innerHTML = metrics.map(m=>`<option value="${m}">${m.replaceAll('_',' ').toUpperCase()}</option>`).join('');
  metricSel.value = metrics.includes('MEDIAN_DOM') ? 'MEDIAN_DOM' : metrics[0];
  const states = Array.from(new Set(rows.map(r=>r.STATE_CODE))).sort();
  statesSel.innerHTML = `<option value="(All)">(All)</option>` + states.map(s=>`<option value="${s}">${s}</option>`).join('');
  statesSel.options[0].selected = true;
  periodEl.textContent = `Period: ${period.trim()}`;

  // 工具函数
  const pad5 = s => String(s).padStart(5,'0');
  const quantile = (sorted,p) => sorted[Math.floor((sorted.length-1)*p)];
  const fmtVal = (metric,v)=>{
    const n=Number(v); if(!Number.isFinite(n)) return 'No data';
    if(metric.includes('PRICE')||metric.includes('PPSF')) return `$${n.toLocaleString()}`;
    if(metric==='MEDIAN_DOM') return `${Math.round(n)} days`;
    if(['AVG_SALE_TO_LIST','SOLD_ABOVE_LIST','PRICE_DROPS','OFF_MARKET_IN_TWO_WEEKS'].includes(metric)) return `${(n*100).toFixed(1)}%`;
    return n.toLocaleString();
  };

  // 初始化 globe
  const globe = Globe({ rendererConfig:{alpha:true,antialias:true} })(document.getElementById('globe'))
    .backgroundColor('rgba(0,0,0,0)')
    .pointOfView({lat:38,lng:-98,altitude:1.5});

  // 隐藏球体网格
  setTimeout(()=>{
    const scene = globe.scene();
    const globeMesh = scene.children.find(o => o.material === globe.globeMaterial());
    if (globeMesh) globeMesh.visible = false;
  },300);

  // 经纬网
  if (typeof globe.showGraticules === 'function') globe.showGraticules(CONFIG.SHOW_GRATICULES);
  if (typeof globe.graticulesColor === 'function') globe.graticulesColor(CONFIG.GRATICULES_COLOR);

  // topo → geojson
  const countiesGeo = topojson.feature(countiesTopo, countiesTopo.objects.counties);
  const landPolys = (worldLand?.features||[]).map(f=>Object.assign({},f,{isLand:true}));

  const selectedFips = new Set(); let hoverId=null;

  function refreshStyles(){
    globe
      .polygonCapColor(d => selectedFips.has(d.id)? d.__baseColor : (hoverId===d.id? CONFIG.HOVER_COLOR : d.__baseColor))
      .polygonSideColor(d => selectedFips.has(d.id)? d.__baseColor : (hoverId===d.id? CONFIG.HOVER_COLOR : d.__baseColor))
      .polygonStrokeColor(()=> 'transparent')
      .polygonAltitude(d=>{
        const a = d.__altBase||CONFIG.ALT_BASE;
        if (selectedFips.has(d.id)) return a*CONFIG.ALT_SELECT_MULT;
        if (hoverId===d.id) return a*CONFIG.ALT_HOVER_MULT;
        return a;
      });
  }

  function updateData(){
    const metric = metricSel.value;
    const chosen = Array.from(statesSel.selectedOptions).map(o=>o.value);
    const all = chosen.includes('(All)');

    const byFips = Object.fromEntries(rows.map(r=>[pad5(r.FIPS),r]));
    const vals = rows.filter(r=>all||chosen.includes(r.STATE_CODE))
                     .map(r=>+r[metric]).filter(Number.isFinite).sort((a,b)=>a-b);
    if (!vals.length) return;
    const vmin=quantile(vals,0.05), vmax=quantile(vals,0.95);
    const norm=v=>(v-vmin)/(vmax-vmin||1);

    const dataFeats = countiesGeo.features.map(f=>{
      const rec = byFips[pad5(f.id)];
      if(!rec) return null;
      const v = +rec[metric];
      const idx = Number.isFinite(v)? Math.min(7,Math.floor(norm(v)*8)):0;
      const hex=CONFIG.PALETTE[idx].slice(1);
      const r=parseInt(hex.slice(0,2),16),g=parseInt(hex.slice(2,4),16),b=parseInt(hex.slice(4,6),16);
      f.__baseColor=`rgba(${r},${g},${b},${CONFIG.COUNTY_OPACITY})`;
      f.__altBase=CONFIG.ALT_BASE;
      f.__county=rec.REGION; f.__state=rec.STATE_CODE; f.__value=fmtVal(metric,v);
      f.__label=`<div><b>${f.__county}</b><br>${f.__state} — ${f.__value}</div>`;
      return f;
    }).filter(Boolean);

    globe.polygonsData([...landPolys,...dataFeats])
         .polygonLabel(f=>f.isLand?null:f.__label);

    legendTitle.textContent = metric.replaceAll('_',' ').toUpperCase();
    legendBar.style.background=`linear-gradient(90deg,${CONFIG.PALETTE.join(',')})`;
    legendMin.textContent=fmtVal(metric,vmin);
    legendMax.textContent=fmtVal(metric,vmax);
    refreshStyles();
  }

  globe.onPolygonHover(f=>{hoverId=f?f.id:null;refreshStyles();});
  globe.onPolygonClick(f=>{
    if(!f) return;
    selectedFips.has(f.id)?selectedFips.delete(f.id):selectedFips.add(f.id);
    refreshStyles();
    pinnedEl.innerHTML=[...selectedFips].map(id=>{
      const d=globe.polygonsData().find(x=>x.id===id);
      return `<div class="pin"><b>${d.__county}</b><br><span>${d.__state} — ${d.__value}</span></div>`;
    }).join('');
    pinnedEl.style.display=selectedFips.size?'block':'none';
  });

  metricSel.addEventListener('change',updateData);
  statesSel.addEventListener('change',updateData);
  document.getElementById('resetSel').addEventListener('click',()=>{
    selectedFips.clear();refreshStyles();pinnedEl.style.display='none';updateData();
  });

  updateData();
})();
</script>
</body>
</html>
